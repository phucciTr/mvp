var startEndIds = [];
var waypts = [];
var map, marker, infowindow, infowindowContent;

var insertWp = [];

function initMap() {
  map = new google.maps.Map($('#map')[0], {
    center: { lat: -33.8688, lng: 151.2195 },
    zoom: 13
  });

  const directionsService = new google.maps.DirectionsService();
  const directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  directionsRenderer.setPanel($('#right-panel')[0]);

  $('#submit').click(() => calculateAndDisplayRoute(directionsService, directionsRenderer));

  const startPoint = $('#start-point')[0];
  const autocomplete = new google.maps.places.Autocomplete(startPoint);
  autocomplete.bindTo('bounds', map);

  const endPoint = $('#end-point')[0];
  const ep_autocomplete = new google.maps.places.Autocomplete(endPoint);
  ep_autocomplete.bindTo('bounds', map);

  const destinations = $('#waypoints')[0];
  const wp_autocomplete = new google.maps.places.Autocomplete(destinations);
  wp_autocomplete.bindTo('bounds', map);

  // Specify just the place data fields that you need.
  autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(startPoint);

  ep_autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.LEFT_TOP].push(endPoint);

  wp_autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(destinations);

  infowindow = new google.maps.InfoWindow();
  infowindowContent = $('#infowindow-content')[0];
  infowindow.setContent(infowindowContent);

  marker = new google.maps.Marker({ map: map });
  marker.addListener('click', () => {
    infowindow.open(map, marker);
  });

  autocomplete.addListener('place_changed', placeChangeHandler.bind(this, autocomplete, false));
  wp_autocomplete.addListener('place_changed', placeChangeHandler.bind(this, wp_autocomplete, true));
  ep_autocomplete.addListener('place_changed', placeChangeHandler.bind(this, ep_autocomplete, false));
}

var placeChangeHandler = (autocomp, isWaypt) => {

  infowindow.close();

  let place = autocomp.getPlace();
  let address = place.name;
  let id = place.place_id;
  let placeLoc = place.geometry.location;

  if (!place.geometry) {
    return;
  }

  if (place.geometry.viewport) {
    map.fitBounds(place.geometry.viewport);
  } else {
    map.setCenter(placeLoc);
    map.setZoom(17);
  }

  // Set the position of the marker using the place ID and location.
  marker.setPlace({
    placeId: id,
    location: placeLoc
  });

  marker.setVisible(true);
  infowindowContent.children.namedItem('place-name').textContent = address;
  infowindow.open(map, marker);

  if (!isWaypt) {
    startEndIds.push(id);
  }
  if (isWaypt) {
    let point = {};
    point[id] = address;
    insertWp.push(point);

    waypts.push({
      location: { placeId: id },
      stopover: true
    });
  }
};

var calculateAndDisplayRoute = (directionsService, directionsRenderer) => {

  console.log('calculateAndDisplayRoute startEndIds = ', startEndIds);
  console.log('calculateAndDisplayRoute waypts = ', waypts);

  directionsService.route({
    origin: { placeId: startEndIds[0] },
    destination: { placeId: startEndIds[1] },
    waypoints: waypts,
    optimizeWaypoints: true,
    travelMode: google.maps.TravelMode.DRIVING
  }, (response, status) => {
    if (status === 'OK') {

      let re_ordered_waypoints = response.routes[0].waypoint_order;
      let optimizedWaypoints = getOptWaypoints(re_ordered_waypoints);
      let dirUrl = generateURL(optimizedWaypoints);
      console.log('dirUrl = ', dirUrl);

      directionsRenderer.setDirections(response);
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
};

var generateURL = optimizedWaypoints => {
  let startId = startEndIds[0];
  let endId = startEndIds[1];
  let dirUrl = `https://www.google.com/maps/dir/?api=1&origin=start&origin_place_id=${startId}&destination=end&destination_place_id=${endId}&travelmode=driving`;
  dirUrl = attachWaypoints(dirUrl, optimizedWaypoints);
  dirUrl = attachWaypointsIds(dirUrl, optimizedWaypoints);
  return dirUrl;
};

var attachWaypointsIds = (dirUrl, optimizedWaypoints) => {
  let last = optimizedWaypoints.length - 1;
  dirUrl += 'waypoint_place_ids=';

  optimizedWaypoints.forEach((point, index) => {
    let id = Object.keys(point)[0];
    dirUrl += index === last ? id : id + '%7C';
  });

  return dirUrl;
};

var attachWaypoints = (dirUrl, optimizedWaypoints) => {
  let last = optimizedWaypoints.length - 1;
  dirUrl += `&waypoints=`;

  optimizedWaypoints.forEach((point, index) => {
    dirUrl += index === last ? 'id&' : 'id%7C';
  });

  return dirUrl;
};

var getOptWaypoints = orderedWpIndexes => {
  let optimizedWaypoints = [];

  orderedWpIndexes.forEach(wpIndex => {
    optimizedWaypoints.push(insertWp[wpIndex]);
  });

  return optimizedWaypoints;
};

export default initMap;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvZ21hcEluaXQuanMiXSwibmFtZXMiOlsic3RhcnRFbmRJZHMiLCJ3YXlwdHMiLCJtYXAiLCJtYXJrZXIiLCJpbmZvd2luZG93IiwiaW5mb3dpbmRvd0NvbnRlbnQiLCJpbnNlcnRXcCIsImluaXRNYXAiLCJnb29nbGUiLCJtYXBzIiwiTWFwIiwiJCIsImNlbnRlciIsImxhdCIsImxuZyIsInpvb20iLCJkaXJlY3Rpb25zU2VydmljZSIsIkRpcmVjdGlvbnNTZXJ2aWNlIiwiZGlyZWN0aW9uc1JlbmRlcmVyIiwiRGlyZWN0aW9uc1JlbmRlcmVyIiwic2V0TWFwIiwic2V0UGFuZWwiLCJjbGljayIsImNhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZSIsInN0YXJ0UG9pbnQiLCJhdXRvY29tcGxldGUiLCJwbGFjZXMiLCJBdXRvY29tcGxldGUiLCJiaW5kVG8iLCJlbmRQb2ludCIsImVwX2F1dG9jb21wbGV0ZSIsImRlc3RpbmF0aW9ucyIsIndwX2F1dG9jb21wbGV0ZSIsInNldEZpZWxkcyIsImNvbnRyb2xzIiwiQ29udHJvbFBvc2l0aW9uIiwiVE9QX0xFRlQiLCJwdXNoIiwiTEVGVF9UT1AiLCJJbmZvV2luZG93Iiwic2V0Q29udGVudCIsIk1hcmtlciIsImFkZExpc3RlbmVyIiwib3BlbiIsInBsYWNlQ2hhbmdlSGFuZGxlciIsImJpbmQiLCJhdXRvY29tcCIsImlzV2F5cHQiLCJjbG9zZSIsInBsYWNlIiwiZ2V0UGxhY2UiLCJhZGRyZXNzIiwibmFtZSIsImlkIiwicGxhY2VfaWQiLCJwbGFjZUxvYyIsImdlb21ldHJ5IiwibG9jYXRpb24iLCJ2aWV3cG9ydCIsImZpdEJvdW5kcyIsInNldENlbnRlciIsInNldFpvb20iLCJzZXRQbGFjZSIsInBsYWNlSWQiLCJzZXRWaXNpYmxlIiwiY2hpbGRyZW4iLCJuYW1lZEl0ZW0iLCJ0ZXh0Q29udGVudCIsInBvaW50Iiwic3RvcG92ZXIiLCJjb25zb2xlIiwibG9nIiwicm91dGUiLCJvcmlnaW4iLCJkZXN0aW5hdGlvbiIsIndheXBvaW50cyIsIm9wdGltaXplV2F5cG9pbnRzIiwidHJhdmVsTW9kZSIsIlRyYXZlbE1vZGUiLCJEUklWSU5HIiwicmVzcG9uc2UiLCJzdGF0dXMiLCJyZV9vcmRlcmVkX3dheXBvaW50cyIsInJvdXRlcyIsIndheXBvaW50X29yZGVyIiwib3B0aW1pemVkV2F5cG9pbnRzIiwiZ2V0T3B0V2F5cG9pbnRzIiwiZGlyVXJsIiwiZ2VuZXJhdGVVUkwiLCJzZXREaXJlY3Rpb25zIiwid2luZG93IiwiYWxlcnQiLCJzdGFydElkIiwiZW5kSWQiLCJhdHRhY2hXYXlwb2ludHMiLCJhdHRhY2hXYXlwb2ludHNJZHMiLCJsYXN0IiwibGVuZ3RoIiwiZm9yRWFjaCIsImluZGV4IiwiT2JqZWN0Iiwia2V5cyIsIm9yZGVyZWRXcEluZGV4ZXMiLCJ3cEluZGV4Il0sIm1hcHBpbmdzIjoiQUFBQSxJQUFJQSxjQUFjLEVBQWxCO0FBQ0EsSUFBSUMsU0FBUyxFQUFiO0FBQ0EsSUFBSUMsR0FBSixFQUFTQyxNQUFULEVBQWlCQyxVQUFqQixFQUE2QkMsaUJBQTdCOztBQUVBLElBQUlDLFdBQVcsRUFBZjs7QUFHQSxTQUFTQyxPQUFULEdBQW1CO0FBQ2pCTCxRQUFNLElBQUlNLE9BQU9DLElBQVAsQ0FBWUMsR0FBaEIsQ0FBb0JDLEVBQUUsTUFBRixFQUFVLENBQVYsQ0FBcEIsRUFBa0M7QUFDdENDLFlBQVEsRUFBRUMsS0FBSyxDQUFDLE9BQVIsRUFBaUJDLEtBQUssUUFBdEIsRUFEOEI7QUFFdENDLFVBQU07QUFGZ0MsR0FBbEMsQ0FBTjs7QUFLQSxRQUFNQyxvQkFBb0IsSUFBSVIsT0FBT0MsSUFBUCxDQUFZUSxpQkFBaEIsRUFBMUI7QUFDQSxRQUFNQyxxQkFBcUIsSUFBSVYsT0FBT0MsSUFBUCxDQUFZVSxrQkFBaEIsRUFBM0I7QUFDQUQscUJBQW1CRSxNQUFuQixDQUEwQmxCLEdBQTFCO0FBQ0FnQixxQkFBbUJHLFFBQW5CLENBQTRCVixFQUFFLGNBQUYsRUFBa0IsQ0FB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WSxNQUFuQixHQUE0QixDQUF2QztBQUNBVixZQUFVLHFCQUFWOztBQUVBRixxQkFBbUJhLE9BQW5CLENBQTJCLENBQUM5QixLQUFELEVBQVErQixLQUFSLEtBQWtCO0FBQzNDLFFBQUk5QyxLQUFLK0MsT0FBT0MsSUFBUCxDQUFZakMsS0FBWixFQUFtQixDQUFuQixDQUFUO0FBQ0FtQixjQUFXWSxVQUFVSCxJQUFYLEdBQW1CM0MsRUFBbkIsR0FBeUJBLEtBQUssS0FBeEM7QUFDRCxHQUhEOztBQUtBLFNBQU9rQyxNQUFQO0FBQ0QsQ0FWRDs7QUFZQSxJQUFJTyxrQkFBa0IsQ0FBQ1AsTUFBRCxFQUFTRixrQkFBVCxLQUFnQztBQUNwRCxNQUFJVyxPQUFPWCxtQkFBbUJZLE1BQW5CLEdBQTRCLENBQXZDO0FBQ0FWLFlBQVcsYUFBWDs7QUFFQUYscUJBQW1CYSxPQUFuQixDQUEyQixDQUFDOUIsS0FBRCxFQUFRK0IsS0FBUixLQUFrQjtBQUMzQ1osY0FBV1ksVUFBVUgsSUFBWCxHQUFtQixLQUFuQixHQUEyQixPQUFyQztBQUNELEdBRkQ7O0FBSUEsU0FBT1QsTUFBUDtBQUNELENBVEQ7O0FBWUEsSUFBSUQsa0JBQW1CZ0IsZ0JBQUQsSUFBc0I7QUFDMUMsTUFBSWpCLHFCQUFxQixFQUF6Qjs7QUFFQWlCLG1CQUFpQkosT0FBakIsQ0FBMEJLLE9BQUQsSUFBYTtBQUNwQ2xCLHVCQUFtQmhELElBQW5CLENBQXdCL0IsU0FBU2lHLE9BQVQsQ0FBeEI7QUFDRCxHQUZEOztBQUlBLFNBQU9sQixrQkFBUDtBQUNELENBUkQ7O0FBVUEsZUFBZTlFLE9BQWYiLCJmaWxlIjoiZ21hcEluaXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgc3RhcnRFbmRJZHMgPSBbXTtcbnZhciB3YXlwdHMgPSBbXTtcbnZhciBtYXAsIG1hcmtlciwgaW5mb3dpbmRvdywgaW5mb3dpbmRvd0NvbnRlbnQ7XG5cbnZhciBpbnNlcnRXcCA9IFtdO1xuXG5cbmZ1bmN0aW9uIGluaXRNYXAoKSB7XG4gIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAoJCgnI21hcCcpWzBdLCB7XG4gICAgY2VudGVyOiB7IGxhdDogLTMzLjg2ODgsIGxuZzogMTUxLjIxOTUgfSxcbiAgICB6b29tOiAxMyxcbiAgfSk7XG5cbiAgY29uc3QgZGlyZWN0aW9uc1NlcnZpY2UgPSBuZXcgZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1NlcnZpY2UoKTtcbiAgY29uc3QgZGlyZWN0aW9uc1JlbmRlcmVyID0gbmV3IGdvb2dsZS5tYXBzLkRpcmVjdGlvbnNSZW5kZXJlcigpO1xuICBkaXJlY3Rpb25zUmVuZGVyZXIuc2V0TWFwKG1hcCk7XG4gIGRpcmVjdGlvbnNSZW5kZXJlci5zZXRQYW5lbCgkKCcjcmlnaHQtcGFuZWwnKVswXSk7XG5cbiAgJCgnI3N1Ym1pdCcpLmNsaWNrKCgpID0+IGNhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZShkaXJlY3Rpb25zU2VydmljZSwgZGlyZWN0aW9uc1JlbmRlcmVyKSk7XG5cbiAgY29uc3Qgc3RhcnRQb2ludCA9ICQoJyNzdGFydC1wb2ludCcpWzBdO1xuICBjb25zdCBhdXRvY29tcGxldGUgPSBuZXcgZ29vZ2xlLm1hcHMucGxhY2VzLkF1dG9jb21wbGV0ZShzdGFydFBvaW50KTtcbiAgYXV0b2NvbXBsZXRlLmJpbmRUbygnYm91bmRzJywgbWFwKTtcblxuICBjb25zdCBlbmRQb2ludCA9ICQoJyNlbmQtcG9pbnQnKVswXTtcbiAgY29uc3QgZXBfYXV0b2NvbXBsZXRlID0gbmV3IGdvb2dsZS5tYXBzLnBsYWNlcy5BdXRvY29tcGxldGUoZW5kUG9pbnQpO1xuICBlcF9hdXRvY29tcGxldGUuYmluZFRvKCdib3VuZHMnLCBtYXApO1xuXG4gIGNvbnN0IGRlc3RpbmF0aW9ucyA9ICQoJyN3YXlwb2ludHMnKVswXTtcbiAgY29uc3Qgd3BfYXV0b2NvbXBsZXRlID0gbmV3IGdvb2dsZS5tYXBzLnBsYWNlcy5BdXRvY29tcGxldGUoZGVzdGluYXRpb25zKTtcbiAgd3BfYXV0b2NvbXBsZXRlLmJpbmRUbygnYm91bmRzJywgbWFwKTtcblxuICAvLyBTcGVjaWZ5IGp1c3QgdGhlIHBsYWNlIGRhdGEgZmllbGRzIHRoYXQgeW91IG5lZWQuXG4gIGF1dG9jb21wbGV0ZS5zZXRGaWVsZHMoWydwbGFjZV9pZCcsICdnZW9tZXRyeScsICduYW1lJ10pO1xuICBtYXAuY29udHJvbHNbZ29vZ2xlLm1hcHMuQ29udHJvbFBvc2l0aW9uLlRPUF9MRUZUXS5wdXNoKHN0YXJ0UG9pbnQpO1xuXG4gIGVwX2F1dG9jb21wbGV0ZS5zZXRGaWVsZHMoWydwbGFjZV9pZCcsICdnZW9tZXRyeScsICduYW1lJ10pO1xuICBtYXAuY29udHJvbHNbZ29vZ2xlLm1hcHMuQ29udHJvbFBvc2l0aW9uLkxFRlRfVE9QXS5wdXNoKGVuZFBvaW50KTtcblxuICB3cF9hdXRvY29tcGxldGUuc2V0RmllbGRzKFsncGxhY2VfaWQnLCAnZ2VvbWV0cnknLCAnbmFtZSddKTtcbiAgbWFwLmNvbnRyb2xzW2dvb2dsZS5tYXBzLkNvbnRyb2xQb3NpdGlvbi5UT1BfTEVGVF0ucHVzaChkZXN0aW5hdGlvbnMpO1xuXG4gIGluZm93aW5kb3cgPSBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdygpO1xuICBpbmZvd2luZG93Q29udGVudCA9ICQoJyNpbmZvd2luZG93LWNvbnRlbnQnKVswXTtcbiAgaW5mb3dpbmRvdy5zZXRDb250ZW50KGluZm93aW5kb3dDb250ZW50KTtcblxuICBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHsgbWFwOiBtYXAgfSk7XG4gIG1hcmtlci5hZGRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgaW5mb3dpbmRvdy5vcGVuKG1hcCwgbWFya2VyKTtcbiAgfSk7XG5cbiAgYXV0b2NvbXBsZXRlLmFkZExpc3RlbmVyKCdwbGFjZV9jaGFuZ2VkJywgcGxhY2VDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcywgYXV0b2NvbXBsZXRlLCBmYWxzZSkpO1xuICB3cF9hdXRvY29tcGxldGUuYWRkTGlzdGVuZXIoJ3BsYWNlX2NoYW5nZWQnLCBwbGFjZUNoYW5nZUhhbmRsZXIuYmluZCh0aGlzLCB3cF9hdXRvY29tcGxldGUsIHRydWUpKTtcbiAgZXBfYXV0b2NvbXBsZXRlLmFkZExpc3RlbmVyKCdwbGFjZV9jaGFuZ2VkJywgcGxhY2VDaGFuZ2VIYW5kbGVyLmJpbmQodGhpcywgZXBfYXV0b2NvbXBsZXRlLCBmYWxzZSkpXG59XG5cblxudmFyIHBsYWNlQ2hhbmdlSGFuZGxlciA9IChhdXRvY29tcCwgaXNXYXlwdCkgPT4ge1xuXG4gIGluZm93aW5kb3cuY2xvc2UoKTtcblxuICBsZXQgcGxhY2UgPSBhdXRvY29tcC5nZXRQbGFjZSgpO1xuICBsZXQgYWRkcmVzcyA9IHBsYWNlLm5hbWU7XG4gIGxldCBpZCA9IHBsYWNlLnBsYWNlX2lkO1xuICBsZXQgcGxhY2VMb2MgPSBwbGFjZS5nZW9tZXRyeS5sb2NhdGlvbjtcblxuICBpZiAoIXBsYWNlLmdlb21ldHJ5KSB7IHJldHVybjsgfVxuXG4gIGlmIChwbGFjZS5nZW9tZXRyeS52aWV3cG9ydCkge1xuICAgIG1hcC5maXRCb3VuZHMocGxhY2UuZ2VvbWV0cnkudmlld3BvcnQpO1xuICB9IGVsc2Uge1xuICAgIG1hcC5zZXRDZW50ZXIocGxhY2VMb2MpO1xuICAgIG1hcC5zZXRab29tKDE3KTtcbiAgfVxuXG4gIC8vIFNldCB0aGUgcG9zaXRpb24gb2YgdGhlIG1hcmtlciB1c2luZyB0aGUgcGxhY2UgSUQgYW5kIGxvY2F0aW9uLlxuICBtYXJrZXIuc2V0UGxhY2Uoe1xuICAgIHBsYWNlSWQ6IGlkLFxuICAgIGxvY2F0aW9uOiBwbGFjZUxvYyxcbiAgfSk7XG5cbiAgbWFya2VyLnNldFZpc2libGUodHJ1ZSk7XG4gIGluZm93aW5kb3dDb250ZW50LmNoaWxkcmVuLm5hbWVkSXRlbSgncGxhY2UtbmFtZScpLnRleHRDb250ZW50ID0gYWRkcmVzcztcbiAgaW5mb3dpbmRvdy5vcGVuKG1hcCwgbWFya2VyKTtcblxuICBpZiAoIWlzV2F5cHQpIHsgc3RhcnRFbmRJZHMucHVzaChpZCk7IH1cbiAgaWYgKGlzV2F5cHQpIHtcbiAgICBsZXQgcG9pbnQgPSB7fTtcbiAgICBwb2ludFtpZF0gPSBhZGRyZXNzO1xuICAgIGluc2VydFdwLnB1c2gocG9pbnQpO1xuXG4gICAgd2F5cHRzLnB1c2goe1xuICAgICAgICBsb2NhdGlvbjogeyBwbGFjZUlkOiBpZCB9LFxuICAgICAgICBzdG9wb3ZlcjogdHJ1ZVxuICAgIH0pO1xuICB9XG59O1xuXG5cbnZhciBjYWxjdWxhdGVBbmREaXNwbGF5Um91dGUgPSAoZGlyZWN0aW9uc1NlcnZpY2UsIGRpcmVjdGlvbnNSZW5kZXJlcikgPT4ge1xuXG4gIGNvbnNvbGUubG9nKCdjYWxjdWxhdGVBbmREaXNwbGF5Um91dGUgc3RhcnRFbmRJZHMgPSAnLCBzdGFydEVuZElkcyk7XG4gIGNvbnNvbGUubG9nKCdjYWxjdWxhdGVBbmREaXNwbGF5Um91dGUgd2F5cHRzID0gJywgd2F5cHRzKTtcblxuICBkaXJlY3Rpb25zU2VydmljZS5yb3V0ZShcbiAgICB7XG4gICAgICBvcmlnaW46IHsgcGxhY2VJZDogc3RhcnRFbmRJZHNbMF0gfSxcbiAgICAgIGRlc3RpbmF0aW9uOiB7IHBsYWNlSWQ6IHN0YXJ0RW5kSWRzWzFdIH0sXG4gICAgICB3YXlwb2ludHM6IHdheXB0cyxcbiAgICAgIG9wdGltaXplV2F5cG9pbnRzOiB0cnVlLFxuICAgICAgdHJhdmVsTW9kZTogZ29vZ2xlLm1hcHMuVHJhdmVsTW9kZS5EUklWSU5HLFxuICAgIH0sXG4gICAgKHJlc3BvbnNlLCBzdGF0dXMpID0+IHtcbiAgICAgIGlmIChzdGF0dXMgPT09ICdPSycpIHtcblxuICAgICAgICBsZXQgcmVfb3JkZXJlZF93YXlwb2ludHMgPSByZXNwb25zZS5yb3V0ZXNbMF0ud2F5cG9pbnRfb3JkZXI7XG4gICAgICAgIGxldCBvcHRpbWl6ZWRXYXlwb2ludHMgPSBnZXRPcHRXYXlwb2ludHMocmVfb3JkZXJlZF93YXlwb2ludHMpO1xuICAgICAgICBsZXQgZGlyVXJsID0gZ2VuZXJhdGVVUkwob3B0aW1pemVkV2F5cG9pbnRzKTtcbiAgICAgICAgY29uc29sZS5sb2coJ2RpclVybCA9ICcsIGRpclVybCk7XG5cbiAgICAgICAgZGlyZWN0aW9uc1JlbmRlcmVyLnNldERpcmVjdGlvbnMocmVzcG9uc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd2luZG93LmFsZXJ0KCdEaXJlY3Rpb25zIHJlcXVlc3QgZmFpbGVkIGR1ZSB0byAnICsgc3RhdHVzKTtcbiAgICAgIH1cbiAgICB9XG4gICk7XG5cbn07XG5cbnZhciBnZW5lcmF0ZVVSTCA9IChvcHRpbWl6ZWRXYXlwb2ludHMpID0+IHtcbiAgbGV0IHN0YXJ0SWQgPSBzdGFydEVuZElkc1swXTtcbiAgbGV0IGVuZElkID0gc3RhcnRFbmRJZHNbMV07XG4gIGxldCBkaXJVcmwgPSBgaHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9tYXBzL2Rpci8/YXBpPTEmb3JpZ2luPXN0YXJ0Jm9yaWdpbl9wbGFjZV9pZD0ke3N0YXJ0SWR9JmRlc3RpbmF0aW9uPWVuZCZkZXN0aW5hdGlvbl9wbGFjZV9pZD0ke2VuZElkfSZ0cmF2ZWxtb2RlPWRyaXZpbmdgO1xuICBkaXJVcmwgPSBhdHRhY2hXYXlwb2ludHMoZGlyVXJsLCBvcHRpbWl6ZWRXYXlwb2ludHMpO1xuICBkaXJVcmwgPSBhdHRhY2hXYXlwb2ludHNJZHMoZGlyVXJsLCBvcHRpbWl6ZWRXYXlwb2ludHMpO1xuICByZXR1cm4gZGlyVXJsO1xufTtcblxuXG52YXIgYXR0YWNoV2F5cG9pbnRzSWRzID0gKGRpclVybCwgb3B0aW1pemVkV2F5cG9pbnRzKSA9PiB7XG4gIGxldCBsYXN0ID0gb3B0aW1pemVkV2F5cG9pbnRzLmxlbmd0aCAtIDE7XG4gIGRpclVybCArPSAnd2F5cG9pbnRfcGxhY2VfaWRzPSc7XG5cbiAgb3B0aW1pemVkV2F5cG9pbnRzLmZvckVhY2goKHBvaW50LCBpbmRleCkgPT4ge1xuICAgIGxldCBpZCA9IE9iamVjdC5rZXlzKHBvaW50KVswXTtcbiAgICBkaXJVcmwgKz0gKGluZGV4ID09PSBsYXN0KSA/IGlkIDogKGlkICsgJyU3QycpO1xuICB9KTtcblxuICByZXR1cm4gZGlyVXJsO1xufVxuXG52YXIgYXR0YWNoV2F5cG9pbnRzID0gKGRpclVybCwgb3B0aW1pemVkV2F5cG9pbnRzKSA9PiB7XG4gIGxldCBsYXN0ID0gb3B0aW1pemVkV2F5cG9pbnRzLmxlbmd0aCAtIDE7XG4gIGRpclVybCArPSBgJndheXBvaW50cz1gO1xuXG4gIG9wdGltaXplZFdheXBvaW50cy5mb3JFYWNoKChwb2ludCwgaW5kZXgpID0+IHtcbiAgICBkaXJVcmwgKz0gKGluZGV4ID09PSBsYXN0KSA/ICdpZCYnIDogJ2lkJTdDJztcbiAgfSk7XG5cbiAgcmV0dXJuIGRpclVybDtcbn07XG5cblxudmFyIGdldE9wdFdheXBvaW50cyA9IChvcmRlcmVkV3BJbmRleGVzKSA9PiB7XG4gIGxldCBvcHRpbWl6ZWRXYXlwb2ludHMgPSBbXTtcblxuICBvcmRlcmVkV3BJbmRleGVzLmZvckVhY2goKHdwSW5kZXgpID0+IHtcbiAgICBvcHRpbWl6ZWRXYXlwb2ludHMucHVzaChpbnNlcnRXcFt3cEluZGV4XSlcbiAgfSk7XG5cbiAgcmV0dXJuIG9wdGltaXplZFdheXBvaW50c1xufTtcblxuZXhwb3J0IGRlZmF1bHQgaW5pdE1hcDtcbiJdfQ==