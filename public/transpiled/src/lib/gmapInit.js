var startEndIds = [];
var waypts = [];
var map, marker, infowindow, infowindowContent;

var insertWp = [];

function initMap() {
  map = new google.maps.Map($('#map')[0], {
    center: { lat: -33.8688, lng: 151.2195 },
    zoom: 13
  });

  const directionsService = new google.maps.DirectionsService();
  const directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  directionsRenderer.setPanel($('#right-panel')[0]);

  $('#submit').click(() => calculateAndDisplayRoute(directionsService, directionsRenderer));

  const startPoint = $('#start-point')[0];
  const autocomplete = new google.maps.places.Autocomplete(startPoint);
  autocomplete.bindTo('bounds', map);

  const endPoint = $('#end-point')[0];
  const ep_autocomplete = new google.maps.places.Autocomplete(endPoint);
  ep_autocomplete.bindTo('bounds', map);

  const destinations = $('#waypoints')[0];
  const wp_autocomplete = new google.maps.places.Autocomplete(destinations);
  wp_autocomplete.bindTo('bounds', map);

  // Specify just the place data fields that you need.
  autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(startPoint);

  ep_autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.LEFT_TOP].push(endPoint);

  wp_autocomplete.setFields(['place_id', 'geometry', 'name']);
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(destinations);

  infowindow = new google.maps.InfoWindow();
  infowindowContent = $('#infowindow-content')[0];
  infowindow.setContent(infowindowContent);

  marker = new google.maps.Marker({ map: map });
  marker.addListener('click', () => {
    infowindow.open(map, marker);
  });

  autocomplete.addListener('place_changed', placeChangeHandler.bind(this, autocomplete, false));
  wp_autocomplete.addListener('place_changed', placeChangeHandler.bind(this, wp_autocomplete, true));
  ep_autocomplete.addListener('place_changed', placeChangeHandler.bind(this, ep_autocomplete, false));
}

var placeChangeHandler = (autocomp, isWaypt) => {

  infowindow.close();

  let place = autocomp.getPlace();
  let address = place.name;
  let id = place.place_id;
  let placeLoc = place.geometry.location;

  if (!place.geometry) {
    return;
  }

  if (place.geometry.viewport) {
    map.fitBounds(place.geometry.viewport);
  } else {
    map.setCenter(placeLoc);
    map.setZoom(17);
  }

  // Set the position of the marker using the place ID and location.
  marker.setPlace({
    placeId: id,
    location: placeLoc
  });

  marker.setVisible(true);
  infowindowContent.children.namedItem('place-name').textContent = address;
  infowindow.open(map, marker);

  if (!isWaypt) {
    startEndIds.push(id);
  }
  if (isWaypt) {
    let point = {};
    point[id] = address;
    insertWp.push(point);

    waypts.push({
      location: { placeId: id },
      stopover: true
    });
  }
};

var calculateAndDisplayRoute = (directionsService, directionsRenderer) => {

  console.log('calculateAndDisplayRoute startEndIds = ', startEndIds);
  console.log('calculateAndDisplayRoute waypts = ', waypts);

  directionsService.route({
    origin: { placeId: startEndIds[0] },
    destination: { placeId: startEndIds[1] },
    waypoints: waypts,
    optimizeWaypoints: true,
    travelMode: google.maps.TravelMode.DRIVING
  }, (response, status) => {
    if (status === 'OK') {

      let re_ordered_waypoints = response.routes[0].waypoint_order;
      let optimizedWaypoints = getOptWaypoints(re_ordered_waypoints);
      let dirUrl = generateURL(optimizedWaypoints);
      $('#url').attr('href', dirUrl).text('Link To Nav');

      directionsRenderer.setDirections(response);
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
};

var generateURL = optimizedWaypoints => {
  let startId = startEndIds[0];
  let endId = startEndIds[1];
  let dirUrl = `https://www.google.com/maps/dir/?api=1&origin=start&origin_place_id=${startId}&destination=end&destination_place_id=${endId}&travelmode=driving`;
  dirUrl = attachWaypoints(dirUrl, optimizedWaypoints);
  dirUrl = attachWaypointsIds(dirUrl, optimizedWaypoints);
  return dirUrl;
};

var attachWaypointsIds = (dirUrl, optimizedWaypoints) => {
  let last = optimizedWaypoints.length - 1;
  dirUrl += 'waypoint_place_ids=';

  optimizedWaypoints.forEach((point, index) => {
    let id = Object.keys(point)[0];
    dirUrl += index === last ? id : id + '%7C';
  });

  return dirUrl;
};

var attachWaypoints = (dirUrl, optimizedWaypoints) => {
  let last = optimizedWaypoints.length - 1;
  dirUrl += `&waypoints=`;

  optimizedWaypoints.forEach((point, index) => {
    dirUrl += index === last ? 'id&' : 'id%7C';
  });

  return dirUrl;
};

var getOptWaypoints = orderedWpIndexes => {
  let optimizedWaypoints = [];

  orderedWpIndexes.forEach(wpIndex => {
    optimizedWaypoints.push(insertWp[wpIndex]);
  });

  return optimizedWaypoints;
};

export default initMap;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvZ21hcEluaXQuanMiXSwibmFtZXMiOlsic3RhcnRFbmRJZHMiLCJ3YXlwdHMiLCJtYXAiLCJtYXJrZXIiLCJpbmZvd2luZG93IiwiaW5mb3dpbmRvd0NvbnRlbnQiLCJpbnNlcnRXcCIsImluaXRNYXAiLCJnb29nbGUiLCJtYXBzIiwiTWFwIiwiJCIsImNlbnRlciIsImxhdCIsImxuZyIsInpvb20iLCJkaXJlY3Rpb25zU2VydmljZSIsIkRpcmVjdGlvbnNTZXJ2aWNlIiwiZGlyZWN0aW9uc1JlbmRlcmVyIiwiRGlyZWN0aW9uc1JlbmRlcmVyIiwic2V0TWFwIiwic2V0UGFuZWwiLCJjbGljayIsImNhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZSIsInN0YXJ0UG9pbnQiLCJhdXRvY29tcGxldGUiLCJwbGFjZXMiLCJBdXRvY29tcGxldGUiLCJiaW5kVG8iLCJlbmRQb2ludCIsImVwX2F1dG9jb21wbGV0ZSIsImRlc3RpbmF0aW9ucyIsIndwX2F1dG9jb21wbGV0ZSIsInNldEZpZWxkcyIsImNvbnRyb2xzIiwiQ29udHJvbFBvc2l0aW9uIiwiVE9QX0xFRlQiLCJwdXNoIiwiTEVGVF9UT1AiLCJJbmZvV2luZG93Iiwic2V0Q29udGVudCIsIk1hcmtlciIsImFkZExpc3RlbmVyIiwib3BlbiIsInBsYWNlQ2hhbmdlSGFuZGxlciIsImJpbmQiLCJhdXRvY29tcCIsImlzV2F5cHQiLCJjbG9zZSIsInBsYWNlIiwiZ2V0UGxhY2UiLCJhZGRyZXNzIiwibmFtZSIsImlkIiwicGxhY2VfaWQiLCJwbGFjZUxvYyIsImdlb21ldHJ5IiwibG9jYXRpb24iLCJ2aWV3cG9ydCIsImZpdEJvdW5kcyIsInNldENlbnRlciIsInNldFpvb20iLCJzZXRQbGFjZSIsInBsYWNlSWQiLCJzZXRWaXNpYmxlIiwiY2hpbGRyZW4iLCJuYW1lZEl0ZW0iLCJ0ZXh0Q29udGVudCIsInBvaW50Iiwic3RvcG92ZXIiLCJjb25zb2xlIiwibG9nIiwicm91dGUiLCJvcmlnaW4iLCJkZXN0aW5hdGlvbiIsIndheXBvaW50cyIsIm9wdGltaXplV2F5cG9pbnRzIiwidHJhdmVsTW9kZSIsIlRyYXZlbE1vZGUiLCJEUklWSU5HIiwicmVzcG9uc2UiLCJzdGF0dXMiLCJyZV9vcmRlcmVkX3dheXBvaW50cyIsInJvdXRlcyIsIndheXBvaW50X29yZGVyIiwib3B0aW1pemVkV2F5cG9pbnRzIiwiZ2V0T3B0V2F5cG9pbnRzIiwiZGlyVXJsIiwiZ2VuZXJhdGVVUkwiLCJhdHRyIiwidGV4dCIsInNldERpcmVjdGlvbnMiLCJ3aW5kb3ciLCJhbGVydCIsInN0YXJ0SWQiLCJlbmRJZCIsImF0dGFjaFdheXBvaW50cyIsImF0dGFjaFdheXBvaW50c0lkcyIsImxhc3QiLCJsZW5ndGgiLCJmb3JFYWNoIiwiaW5kZXgiLCJPYmplY3QiLCJrZXlzIiwib3JkZXJlZFdwSW5kZXhlcyIsIndwSW5kZXgiXSwibWFwcGluZ3MiOiJBQUFBLElBQUlBLGNBQWMsRUFBbEI7QUFDQSxJQUFJQyxTQUFTLEVBQWI7QUFDQSxJQUFJQyxHQUFKLEVBQVNDLE1BQVQsRUFBaUJDLFVBQWpCLEVBQTZCQyxpQkFBN0I7O0FBRUEsSUFBSUMsV0FBVyxFQUFmOztBQUdBLFNBQVNDLE9BQVQsR0FBbUI7QUFDakJMLFFBQU0sSUFBSU0sT0FBT0MsSUFBUCxDQUFZQyxHQUFoQixDQUFvQkMsRUFBRSxNQUFGLEVBQVUsQ0FBVixDQUFwQixFQUFrQztBQUN0Q0MsWUFBUSxFQUFFQyxLQUFLLENBQUMsT0FBUixFQUFpQkMsS0FBSyxRQUF0QixFQUQ4QjtBQUV0Q0MsVUFBTTtBQUZnQyxHQUFsQyxDQUFOOztBQUtBLFFBQU1DLG9CQUFvQixJQUFJUixPQUFPQyxJQUFQLENBQVlRLGlCQUFoQixFQUExQjtBQUNBLFFBQU1DLHFCQUFxQixJQUFJVixPQUFPQyxJQUFQLENBQVlVLGtCQUFoQixFQUEzQjtBQUNBRCxxQkFBbUJFLE1BQW5CLENBQTBCbEIsR0FBMUI7QUFDQWdCLHFCQUFtQkcsUUFBbkIsQ0FBNEJWLEVBQUUs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Q1YsTUFBRCxFQUFTRixrQkFBVCxLQUFnQztBQUN2RCxNQUFJYSxPQUFPYixtQkFBbUJjLE1BQW5CLEdBQTRCLENBQXZDO0FBQ0FaLFlBQVUscUJBQVY7O0FBRUFGLHFCQUFtQmUsT0FBbkIsQ0FBMkIsQ0FBQ2hDLEtBQUQsRUFBUWlDLEtBQVIsS0FBa0I7QUFDM0MsUUFBSWhELEtBQUtpRCxPQUFPQyxJQUFQLENBQVluQyxLQUFaLEVBQW1CLENBQW5CLENBQVQ7QUFDQW1CLGNBQVdjLFVBQVVILElBQVgsR0FBbUI3QyxFQUFuQixHQUF5QkEsS0FBSyxLQUF4QztBQUNELEdBSEQ7O0FBS0EsU0FBT2tDLE1BQVA7QUFDRCxDQVZEOztBQVlBLElBQUlTLGtCQUFrQixDQUFDVCxNQUFELEVBQVNGLGtCQUFULEtBQWdDO0FBQ3BELE1BQUlhLE9BQU9iLG1CQUFtQmMsTUFBbkIsR0FBNEIsQ0FBdkM7QUFDQVosWUFBVyxhQUFYOztBQUVBRixxQkFBbUJlLE9BQW5CLENBQTJCLENBQUNoQyxLQUFELEVBQVFpQyxLQUFSLEtBQWtCO0FBQzNDZCxjQUFXYyxVQUFVSCxJQUFYLEdBQW1CLEtBQW5CLEdBQTJCLE9BQXJDO0FBQ0QsR0FGRDs7QUFJQSxTQUFPWCxNQUFQO0FBQ0QsQ0FURDs7QUFZQSxJQUFJRCxrQkFBbUJrQixnQkFBRCxJQUFzQjtBQUMxQyxNQUFJbkIscUJBQXFCLEVBQXpCOztBQUVBbUIsbUJBQWlCSixPQUFqQixDQUEwQkssT0FBRCxJQUFhO0FBQ3BDcEIsdUJBQW1CaEQsSUFBbkIsQ0FBd0IvQixTQUFTbUcsT0FBVCxDQUF4QjtBQUNELEdBRkQ7O0FBSUEsU0FBT3BCLGtCQUFQO0FBQ0QsQ0FSRDs7QUFVQSxlQUFlOUUsT0FBZiIsImZpbGUiOiJnbWFwSW5pdC5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBzdGFydEVuZElkcyA9IFtdO1xudmFyIHdheXB0cyA9IFtdO1xudmFyIG1hcCwgbWFya2VyLCBpbmZvd2luZG93LCBpbmZvd2luZG93Q29udGVudDtcblxudmFyIGluc2VydFdwID0gW107XG5cblxuZnVuY3Rpb24gaW5pdE1hcCgpIHtcbiAgbWFwID0gbmV3IGdvb2dsZS5tYXBzLk1hcCgkKCcjbWFwJylbMF0sIHtcbiAgICBjZW50ZXI6IHsgbGF0OiAtMzMuODY4OCwgbG5nOiAxNTEuMjE5NSB9LFxuICAgIHpvb206IDEzLFxuICB9KTtcblxuICBjb25zdCBkaXJlY3Rpb25zU2VydmljZSA9IG5ldyBnb29nbGUubWFwcy5EaXJlY3Rpb25zU2VydmljZSgpO1xuICBjb25zdCBkaXJlY3Rpb25zUmVuZGVyZXIgPSBuZXcgZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1JlbmRlcmVyKCk7XG4gIGRpcmVjdGlvbnNSZW5kZXJlci5zZXRNYXAobWFwKTtcbiAgZGlyZWN0aW9uc1JlbmRlcmVyLnNldFBhbmVsKCQoJyNyaWdodC1wYW5lbCcpWzBdKTtcblxuICAkKCcjc3VibWl0JykuY2xpY2soKCkgPT4gY2FsY3VsYXRlQW5kRGlzcGxheVJvdXRlKGRpcmVjdGlvbnNTZXJ2aWNlLCBkaXJlY3Rpb25zUmVuZGVyZXIpKTtcblxuICBjb25zdCBzdGFydFBvaW50ID0gJCgnI3N0YXJ0LXBvaW50JylbMF07XG4gIGNvbnN0IGF1dG9jb21wbGV0ZSA9IG5ldyBnb29nbGUubWFwcy5wbGFjZXMuQXV0b2NvbXBsZXRlKHN0YXJ0UG9pbnQpO1xuICBhdXRvY29tcGxldGUuYmluZFRvKCdib3VuZHMnLCBtYXApO1xuXG4gIGNvbnN0IGVuZFBvaW50ID0gJCgnI2VuZC1wb2ludCcpWzBdO1xuICBjb25zdCBlcF9hdXRvY29tcGxldGUgPSBuZXcgZ29vZ2xlLm1hcHMucGxhY2VzLkF1dG9jb21wbGV0ZShlbmRQb2ludCk7XG4gIGVwX2F1dG9jb21wbGV0ZS5iaW5kVG8oJ2JvdW5kcycsIG1hcCk7XG5cbiAgY29uc3QgZGVzdGluYXRpb25zID0gJCgnI3dheXBvaW50cycpWzBdO1xuICBjb25zdCB3cF9hdXRvY29tcGxldGUgPSBuZXcgZ29vZ2xlLm1hcHMucGxhY2VzLkF1dG9jb21wbGV0ZShkZXN0aW5hdGlvbnMpO1xuICB3cF9hdXRvY29tcGxldGUuYmluZFRvKCdib3VuZHMnLCBtYXApO1xuXG4gIC8vIFNwZWNpZnkganVzdCB0aGUgcGxhY2UgZGF0YSBmaWVsZHMgdGhhdCB5b3UgbmVlZC5cbiAgYXV0b2NvbXBsZXRlLnNldEZpZWxkcyhbJ3BsYWNlX2lkJywgJ2dlb21ldHJ5JywgJ25hbWUnXSk7XG4gIG1hcC5jb250cm9sc1tnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb24uVE9QX0xFRlRdLnB1c2goc3RhcnRQb2ludCk7XG5cbiAgZXBfYXV0b2NvbXBsZXRlLnNldEZpZWxkcyhbJ3BsYWNlX2lkJywgJ2dlb21ldHJ5JywgJ25hbWUnXSk7XG4gIG1hcC5jb250cm9sc1tnb29nbGUubWFwcy5Db250cm9sUG9zaXRpb24uTEVGVF9UT1BdLnB1c2goZW5kUG9pbnQpO1xuXG4gIHdwX2F1dG9jb21wbGV0ZS5zZXRGaWVsZHMoWydwbGFjZV9pZCcsICdnZW9tZXRyeScsICduYW1lJ10pO1xuICBtYXAuY29udHJvbHNbZ29vZ2xlLm1hcHMuQ29udHJvbFBvc2l0aW9uLlRPUF9MRUZUXS5wdXNoKGRlc3RpbmF0aW9ucyk7XG5cbiAgaW5mb3dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KCk7XG4gIGluZm93aW5kb3dDb250ZW50ID0gJCgnI2luZm93aW5kb3ctY29udGVudCcpWzBdO1xuICBpbmZvd2luZG93LnNldENvbnRlbnQoaW5mb3dpbmRvd0NvbnRlbnQpO1xuXG4gIG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoeyBtYXA6IG1hcCB9KTtcbiAgbWFya2VyLmFkZExpc3RlbmVyKCdjbGljaycsICgpID0+IHtcbiAgICBpbmZvd2luZG93Lm9wZW4obWFwLCBtYXJrZXIpO1xuICB9KTtcblxuICBhdXRvY29tcGxldGUuYWRkTGlzdGVuZXIoJ3BsYWNlX2NoYW5nZWQnLCBwbGFjZUNoYW5nZUhhbmRsZXIuYmluZCh0aGlzLCBhdXRvY29tcGxldGUsIGZhbHNlKSk7XG4gIHdwX2F1dG9jb21wbGV0ZS5hZGRMaXN0ZW5lcigncGxhY2VfY2hhbmdlZCcsIHBsYWNlQ2hhbmdlSGFuZGxlci5iaW5kKHRoaXMsIHdwX2F1dG9jb21wbGV0ZSwgdHJ1ZSkpO1xuICBlcF9hdXRvY29tcGxldGUuYWRkTGlzdGVuZXIoJ3BsYWNlX2NoYW5nZWQnLCBwbGFjZUNoYW5nZUhhbmRsZXIuYmluZCh0aGlzLCBlcF9hdXRvY29tcGxldGUsIGZhbHNlKSlcbn1cblxuXG52YXIgcGxhY2VDaGFuZ2VIYW5kbGVyID0gKGF1dG9jb21wLCBpc1dheXB0KSA9PiB7XG5cbiAgaW5mb3dpbmRvdy5jbG9zZSgpO1xuXG4gIGxldCBwbGFjZSA9IGF1dG9jb21wLmdldFBsYWNlKCk7XG4gIGxldCBhZGRyZXNzID0gcGxhY2UubmFtZTtcbiAgbGV0IGlkID0gcGxhY2UucGxhY2VfaWQ7XG4gIGxldCBwbGFjZUxvYyA9IHBsYWNlLmdlb21ldHJ5LmxvY2F0aW9uO1xuXG4gIGlmICghcGxhY2UuZ2VvbWV0cnkpIHsgcmV0dXJuOyB9XG5cbiAgaWYgKHBsYWNlLmdlb21ldHJ5LnZpZXdwb3J0KSB7XG4gICAgbWFwLmZpdEJvdW5kcyhwbGFjZS5nZW9tZXRyeS52aWV3cG9ydCk7XG4gIH0gZWxzZSB7XG4gICAgbWFwLnNldENlbnRlcihwbGFjZUxvYyk7XG4gICAgbWFwLnNldFpvb20oMTcpO1xuICB9XG5cbiAgLy8gU2V0IHRoZSBwb3NpdGlvbiBvZiB0aGUgbWFya2VyIHVzaW5nIHRoZSBwbGFjZSBJRCBhbmQgbG9jYXRpb24uXG4gIG1hcmtlci5zZXRQbGFjZSh7XG4gICAgcGxhY2VJZDogaWQsXG4gICAgbG9jYXRpb246IHBsYWNlTG9jLFxuICB9KTtcblxuICBtYXJrZXIuc2V0VmlzaWJsZSh0cnVlKTtcbiAgaW5mb3dpbmRvd0NvbnRlbnQuY2hpbGRyZW4ubmFtZWRJdGVtKCdwbGFjZS1uYW1lJykudGV4dENvbnRlbnQgPSBhZGRyZXNzO1xuICBpbmZvd2luZG93Lm9wZW4obWFwLCBtYXJrZXIpO1xuXG4gIGlmICghaXNXYXlwdCkgeyBzdGFydEVuZElkcy5wdXNoKGlkKTsgfVxuICBpZiAoaXNXYXlwdCkge1xuICAgIGxldCBwb2ludCA9IHt9O1xuICAgIHBvaW50W2lkXSA9IGFkZHJlc3M7XG4gICAgaW5zZXJ0V3AucHVzaChwb2ludCk7XG5cbiAgICB3YXlwdHMucHVzaCh7XG4gICAgICAgIGxvY2F0aW9uOiB7IHBsYWNlSWQ6IGlkIH0sXG4gICAgICAgIHN0b3BvdmVyOiB0cnVlXG4gICAgfSk7XG4gIH1cbn07XG5cblxudmFyIGNhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZSA9IChkaXJlY3Rpb25zU2VydmljZSwgZGlyZWN0aW9uc1JlbmRlcmVyKSA9PiB7XG5cbiAgY29uc29sZS5sb2coJ2NhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZSBzdGFydEVuZElkcyA9ICcsIHN0YXJ0RW5kSWRzKTtcbiAgY29uc29sZS5sb2coJ2NhbGN1bGF0ZUFuZERpc3BsYXlSb3V0ZSB3YXlwdHMgPSAnLCB3YXlwdHMpO1xuXG4gIGRpcmVjdGlvbnNTZXJ2aWNlLnJvdXRlKFxuICAgIHtcbiAgICAgIG9yaWdpbjogeyBwbGFjZUlkOiBzdGFydEVuZElkc1swXSB9LFxuICAgICAgZGVzdGluYXRpb246IHsgcGxhY2VJZDogc3RhcnRFbmRJZHNbMV0gfSxcbiAgICAgIHdheXBvaW50czogd2F5cHRzLFxuICAgICAgb3B0aW1pemVXYXlwb2ludHM6IHRydWUsXG4gICAgICB0cmF2ZWxNb2RlOiBnb29nbGUubWFwcy5UcmF2ZWxNb2RlLkRSSVZJTkcsXG4gICAgfSxcbiAgICAocmVzcG9uc2UsIHN0YXR1cykgPT4ge1xuICAgICAgaWYgKHN0YXR1cyA9PT0gJ09LJykge1xuXG4gICAgICAgIGxldCByZV9vcmRlcmVkX3dheXBvaW50cyA9IHJlc3BvbnNlLnJvdXRlc1swXS53YXlwb2ludF9vcmRlcjtcbiAgICAgICAgbGV0IG9wdGltaXplZFdheXBvaW50cyA9IGdldE9wdFdheXBvaW50cyhyZV9vcmRlcmVkX3dheXBvaW50cyk7XG4gICAgICAgIGxldCBkaXJVcmwgPSBnZW5lcmF0ZVVSTChvcHRpbWl6ZWRXYXlwb2ludHMpO1xuICAgICAgICAkKCcjdXJsJykuYXR0cignaHJlZicsIGRpclVybCkudGV4dCgnTGluayBUbyBOYXYnKTtcblxuICAgICAgICBkaXJlY3Rpb25zUmVuZGVyZXIuc2V0RGlyZWN0aW9ucyhyZXNwb25zZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3aW5kb3cuYWxlcnQoJ0RpcmVjdGlvbnMgcmVxdWVzdCBmYWlsZWQgZHVlIHRvICcgKyBzdGF0dXMpO1xuICAgICAgfVxuICAgIH1cbiAgKTtcblxufTtcblxudmFyIGdlbmVyYXRlVVJMID0gKG9wdGltaXplZFdheXBvaW50cykgPT4ge1xuICBsZXQgc3RhcnRJZCA9IHN0YXJ0RW5kSWRzWzBdO1xuICBsZXQgZW5kSWQgPSBzdGFydEVuZElkc1sxXTtcbiAgbGV0IGRpclVybCA9IGBodHRwczovL3d3dy5nb29nbGUuY29tL21hcHMvZGlyLz9hcGk9MSZvcmlnaW49c3RhcnQmb3JpZ2luX3BsYWNlX2lkPSR7c3RhcnRJZH0mZGVzdGluYXRpb249ZW5kJmRlc3RpbmF0aW9uX3BsYWNlX2lkPSR7ZW5kSWR9JnRyYXZlbG1vZGU9ZHJpdmluZ2A7XG4gIGRpclVybCA9IGF0dGFjaFdheXBvaW50cyhkaXJVcmwsIG9wdGltaXplZFdheXBvaW50cyk7XG4gIGRpclVybCA9IGF0dGFjaFdheXBvaW50c0lkcyhkaXJVcmwsIG9wdGltaXplZFdheXBvaW50cyk7XG4gIHJldHVybiBkaXJVcmw7XG59O1xuXG5cbnZhciBhdHRhY2hXYXlwb2ludHNJZHMgPSAoZGlyVXJsLCBvcHRpbWl6ZWRXYXlwb2ludHMpID0+IHtcbiAgbGV0IGxhc3QgPSBvcHRpbWl6ZWRXYXlwb2ludHMubGVuZ3RoIC0gMTtcbiAgZGlyVXJsICs9ICd3YXlwb2ludF9wbGFjZV9pZHM9JztcblxuICBvcHRpbWl6ZWRXYXlwb2ludHMuZm9yRWFjaCgocG9pbnQsIGluZGV4KSA9PiB7XG4gICAgbGV0IGlkID0gT2JqZWN0LmtleXMocG9pbnQpWzBdO1xuICAgIGRpclVybCArPSAoaW5kZXggPT09IGxhc3QpID8gaWQgOiAoaWQgKyAnJTdDJyk7XG4gIH0pO1xuXG4gIHJldHVybiBkaXJVcmw7XG59XG5cbnZhciBhdHRhY2hXYXlwb2ludHMgPSAoZGlyVXJsLCBvcHRpbWl6ZWRXYXlwb2ludHMpID0+IHtcbiAgbGV0IGxhc3QgPSBvcHRpbWl6ZWRXYXlwb2ludHMubGVuZ3RoIC0gMTtcbiAgZGlyVXJsICs9IGAmd2F5cG9pbnRzPWA7XG5cbiAgb3B0aW1pemVkV2F5cG9pbnRzLmZvckVhY2goKHBvaW50LCBpbmRleCkgPT4ge1xuICAgIGRpclVybCArPSAoaW5kZXggPT09IGxhc3QpID8gJ2lkJicgOiAnaWQlN0MnO1xuICB9KTtcblxuICByZXR1cm4gZGlyVXJsO1xufTtcblxuXG52YXIgZ2V0T3B0V2F5cG9pbnRzID0gKG9yZGVyZWRXcEluZGV4ZXMpID0+IHtcbiAgbGV0IG9wdGltaXplZFdheXBvaW50cyA9IFtdO1xuXG4gIG9yZGVyZWRXcEluZGV4ZXMuZm9yRWFjaCgod3BJbmRleCkgPT4ge1xuICAgIG9wdGltaXplZFdheXBvaW50cy5wdXNoKGluc2VydFdwW3dwSW5kZXhdKVxuICB9KTtcblxuICByZXR1cm4gb3B0aW1pemVkV2F5cG9pbnRzXG59O1xuXG5leHBvcnQgZGVmYXVsdCBpbml0TWFwO1xuIl19